#!/usr/bin/env ruby

require './lib/point'
require './lib/csv_parser'
require './lib/analiser'
require './lib/chart'
require 'pry'

START_POINT = 0
END_POINT = 500

filename = './data/sx5e_index.csv'
points = CsvParser.parse(filename)

points = points[START_POINT..END_POINT]

analiser = Analiser.new(points)
trends = []
analiser.run { |trend| trends << trend }

chart = Chart.new(type: :line, size: 1000)
chart.labels(points.map { |p| p.date.to_s }, 4)

  # px_open
  # px_last
  # px_low
  # rsi_14d
%i{
  mov_avg_20d
  mov_avg_50d
  px_high
}.each do |p|
  chart.data(p, points.map(&p))
end
chart.data('up', points.map { |p| p.uptrend? ? p.mov_avg_20d : nil })
trends.each_with_index do |t,i|
  chart.data("trend-#{i}", Chart.create_trend_line(t.first, t.last))
end

chart.write('bob.png')
`open bob.png`
#`convert -delay 4 output/*.png output/output.gif`
